@page

@{
    var name = "Lights Out ðŸ’¡";
    var description = "Switch off all the lights as fast as you can!";
}

<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>@name</title>
  <meta name="description" content="@description">
  <meta name="author" content="Adrian Vella">

  <meta property="og:title" content="@name">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://lightsout.adrianvella.com">
  <meta property="og:description" content="@description">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <style>
    .container {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translateX(-50%) translateY(-50%);
    }

    game .box {
        background-color: lightgrey;
        color: #fff;
        border-radius: 5px;
        padding: 20px;
        font-size: 150%;
    }

    game .wrapper {
        width: 60%;
        display: grid;
        grid-gap: 10px;
        grid-auto-flow: row;
    }

    game .wrapper .cell {
        cursor: pointer;
    }
  </style>
</head>

<body class="container">
    <h1 class="display-3">@name
        <br/>
        <small class="text-muted">@description</small>
    </h1>
    
    <br/>

    <button id="start" type="button" class="btn btn-outline-primary" onclick="startGame(this)">Start!</button>
    <button id="surrender" type="button" class="btn btn-outline-danger" hidden onclick="surrender(this)">Surrender ðŸ˜­</button>

    <br /><br />

    <game class="display-4"></game>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    <script>
        const startGame = (btn) =>
        {
            btn.hidden = true;

            document.getElementById("surrender").hidden = false;

            fetch("/api/game/play")
                .then(response => {
                    const gameId = response.headers.get("x-gameid");

                    startTime = new Date(parseInt(response.headers.get("x-starttime")) * 1000);

                    moveCount = parseInt(response.headers.get("x-movecount"));

                    const game = document.getElementsByTagName("game")[0];

                    game.id = gameId;

                    return response.text();
                })
                .then(data => {

                    const game = document.getElementsByTagName("game")[0];
                    
                    game.innerHTML = data;
                    
                    game.prepend(
                        `Moves: 0`, 
                        document.createElement("br"),
                        `Started: ${new Date().toLocaleString()}`,
                        document.createElement("br"),
                        document.createElement("br")
                    );

                    const gameWrapper = game.querySelector(".wrapper");

                    const rows = parseInt(gameWrapper.getAttribute("rows"));

                    const columns = parseInt(gameWrapper.getAttribute("columns"));

                    const rowSize = 100 / rows;

                    const columnsSize = 100 / columns;

                    gameWrapper.style.cssText = `grid-template-columns: repeat(${columns}, ${columnsSize}%);grid-template-rows: repeat(${rows}, ${rowSize}%);`;

                    for (const cell of document.querySelectorAll("game .wrapper .cell"))
                    {
                        cell.setAttribute("onclick","toggleCell(this);");
                    }
                });
        };

        const surrender = (btn) =>
        {
            btn.hidden = true;

            document.getElementById("start").hidden = false;

            const game = document.getElementsByTagName("game")[0];

            fetch(`/api/game/surrender/${game.id}`, { method: 'POST' })
                .then(response => response.text())
                .then(data => game.innerHTML = data);
        };

        const toggleCell = (cell) =>
        {
            const row = parseInt(cell.id.substring(1, 2));

            const column = parseInt(cell.id.substring(3, 4));

            const game = document.getElementsByTagName("game")[0];

            let startTime = undefined;
            let moveCount = undefined;
            let isSolved = false;

            fetch(
                    `/api/game/toggle/${game.id}`,
                    {
                        method: 'POST',
                        body: `{ "rowNumber": ${row}, "columnNumber": ${column} }`,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    }
                )
                .then(response => {

                    startTime = new Date(parseInt(response.headers.get("x-starttime")) * 1000);

                    moveCount = parseInt(response.headers.get("x-movecount"));

                    isSolved = parseInt(response.headers.get("x-issolved")) === 1;
                    
                    return response.text();
                })
                .then(data => {
                    const gameWrapper = game.querySelector(".wrapper");

                    const styling = gameWrapper.style.cssText;
                    
                    game.innerHTML = data;

                    if (isSolved)
                    {
                        game.prepend(
                            "Puzzle Solved ðŸŽ‰", 
                            document.createElement("br"),
                            document.createElement("br")
                        );
                    }
                    else
                    {
                        game.prepend(
                            `Moves: ${moveCount}`, 
                            document.createElement("br"),
                            `Started: ${startTime.toLocaleString()}`,
                            document.createElement("br"),
                            document.createElement("br")
                        );
                    }

                    document.querySelector("game .wrapper").style.cssText = styling;
                    
                    if (!isSolved)
                    {
                        for (const cell of document.querySelectorAll("game .wrapper .cell"))
                        {
                            cell.setAttribute("onclick","toggleCell(this);");
                        }
                    }
                });
        };
    </script>
</body>
</html>
