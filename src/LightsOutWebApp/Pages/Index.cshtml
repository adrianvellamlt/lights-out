@page

@{
    var name = "Lights Out ðŸ’¡";
    var description = "Switch off all the lights as fast as you can!";
}

<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>@name</title>
  <meta name="description" content="@description">
  <meta name="author" content="Adrian Vella">

  <meta property="og:title" content="@name">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://lightsout.adrianvella.com">
  <meta property="og:description" content="@description">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <style>
    .container {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translateX(-50%) translateY(-50%);
    }

    game .box {
        background-color: lightgrey;
        color: #fff;
        border-radius: 5px;
        padding: 20px;
        font-size: 150%;
    }

    game .wrapper {
        width: 60%;
        display: grid;
        grid-gap: 10px;
        grid-auto-flow: row;
    }

    game .wrapper .cell {
        cursor: pointer;
    }
  </style>
</head>

<body>
    <div class="container">
        <div class="row">
            <h1 class="display-3">@name
                <br/>
                <small class="text-muted">@description</small>
            </h1>
        </div>

        <br/><br/>

        <div class="row">
            <div class="col-md-4">
                <input id="username" type="text" value="Guest Player" />
            </div>

            <div id="gameSelection" class="col-md-4 dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                    Game Mode
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1"></ul>
            </div>

            <div class="col-md-4">
                <button type="button" onclick="getHighScores()" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#highScoreModal">
                    High Scores!
                </button>
            </div>
        </div>

        <br/><br/>

        <div class="row">
            <div class="col-md-12">
                <button id="start" type="button" class="btn btn-outline-primary" onclick="startGame(this)">Start!</button>
                <button id="surrender" type="button" class="btn btn-outline-danger" hidden onclick="surrender(this)">Surrender ðŸ˜­</button>
            </div>
        </div>

        <br/><br/>

        <div class="row">
            <div class="col-md-12">
                <game class="display-4"></game>
            </div>
        </div>
    </div>

    <!-- High Scores -->
    <div class="modal fade" id="highScoreModal" tabindex="-1" aria-labelledby="highScoreModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">High Scores ðŸ¥³</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Loading...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    <script>
        window.onload = () =>
        {
            fetch("/api/gamesettings")
                .then(response => response.json())
                .then(data => {
                    if (!data.length) return;

                    const list = document.querySelector("#gameSelection ul");

                    const firstId = data[0].id;

                    for (const gameSetting of data)
                    {
                        const text = `${gameSetting.noOfRows} x ${gameSetting.noOfColumns} - Time Limit: ${gameSetting.gameMaxDuration}`;

                        const li = document.createElement("li");

                        const a = document.createElement("a");

                        a.classList.add("dropdown-item");

                        if (gameSetting.id === firstId) a.classList.add("active");

                        a.href = "#";

                        a.setAttribute("gameId", gameSetting.id);

                        a.appendChild(document.createTextNode(text));

                        li.appendChild(a);

                        list.appendChild(li);
                    }

                    for (const aTag of document.querySelectorAll("#gameSelection a"))
                    {
                        aTag.onclick = (e) =>
                        {
                            const thisGameId = e.currentTarget.getAttribute("gameId");

                            for(const a of document.querySelectorAll("#gameSelection a"))
                            {
                                if (a.getAttribute("gameId") !== thisGameId)
                                {
                                    a.classList.remove("active");
                                }
                            }

                            e.currentTarget.classList.add("active");
                        };
                    }
                });
        };

        const startGame = (btn) =>
        {
            btn.hidden = true;

            document.getElementById("surrender").hidden = false;
            document.getElementById("gameSelection").hidden = true;

            const gameId = document.querySelector("#gameSelection .active").getAttribute("gameId");

            const username = document.getElementById("username").value;

            fetch(
                    `/api/game/play/${gameId}`,
                    {
                        method: 'POST',
                        body: `{ "username": "${username}" }`,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    }
                )
                .then(response => {
                    if (response.status === 404)
                    {
                        game.prepend(
                            "Game Over! You took too long to complete the puzzle", 
                            document.createElement("br"),
                            document.createElement("br")
                        );

                        document.getElementById("start").hidden = true;
                        document.getElementById("surrender").hidden = false;
                        document.getElementById("gameSelection").hidden = true;

                        return;
                    }

                    const gameStateId = response.headers.get("x-gamestateid");

                    const game = document.getElementsByTagName("game")[0];

                    game.id = gameStateId;

                    return response.text();
                })
                .then(data => {

                    const game = document.getElementsByTagName("game")[0];

                    window.gameStartTime = new Date();
                    
                    game.innerHTML = data;
                    
                    game.prepend(
                        `Moves: 0`, 
                        document.createElement("br"),
                        `Started: ${window.gameStartTime.toLocaleString()}`,
                        document.createElement("br"),
                        document.createElement("br")
                    );

                    const gameWrapper = game.querySelector(".wrapper");

                    const rows = parseInt(gameWrapper.getAttribute("rows"));

                    const columns = parseInt(gameWrapper.getAttribute("columns"));

                    const rowSize = 100 / rows;

                    const columnsSize = 100 / columns;

                    gameWrapper.style.cssText = `grid-template-columns: repeat(${columns}, ${columnsSize}%);grid-template-rows: repeat(${rows}, ${rowSize}%);`;

                    for (const cell of document.querySelectorAll("game .wrapper .cell"))
                    {
                        cell.setAttribute("onclick","toggleCell(this);");
                    }
                });
        };

        const surrender = (btn) =>
        {
            btn.hidden = true;

            document.getElementById("start").hidden = false;
            document.getElementById("surrender").hidden = true;
            document.getElementById("gameSelection").hidden = false;

            const game = document.getElementsByTagName("game")[0];

            fetch(`/api/game/surrender/${game.id}`, { method: 'POST' })
                .then(response => response.text())
                .then(data => game.innerHTML = data);
        };

        const toggleCell = (cell) =>
        {
            const row = parseInt(cell.id.substring(1, 2));

            const column = parseInt(cell.id.substring(3, 4));

            const game = document.getElementsByTagName("game")[0];

            let remainingSeconds = undefined;
            let moveCount = undefined;
            let isSolved = false;

            fetch(
                    `/api/game/toggle/${game.id}`,
                    {
                        method: 'POST',
                        body: `{ "rowNumber": ${row}, "columnNumber": ${column} }`,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    }
                )
                .then(response => {
                    if (response.status === 404)
                    {
                        game.prepend(
                            "Game Over! You took too long to complete the puzzle", 
                            document.createElement("br"),
                            document.createElement("br")
                        );
                        
                        document.getElementById("start").hidden = false;
                        document.getElementById("surrender").hidden = true;
                        document.getElementById("gameSelection").hidden = false;

                        return;
                    }

                    remainingSeconds = parseInt(response.headers.get("x-remainingtime"));

                    moveCount = parseInt(response.headers.get("x-movecount"));

                    isSolved = parseInt(response.headers.get("x-issolved")) === 1;
                    
                    return response.text();
                })
                .then(data => {
                    const gameWrapper = game.querySelector(".wrapper");

                    const styling = gameWrapper.style.cssText;
                    
                    game.innerHTML = data;

                    if (remainingSeconds === 0)
                    {
                        game.prepend(
                            "Game Over! You took too long to complete the puzzle", 
                            document.createElement("br"),
                            document.createElement("br")
                        );

                        document.getElementById("start").hidden = false;
                        document.getElementById("surrender").hidden = true;
                        document.getElementById("gameSelection").hidden = false;
                    }
                    else if (isSolved)
                    {
                        game.prepend(
                            "Puzzle Solved ðŸŽ‰", 
                            document.createElement("br"),
                            document.createElement("br")
                        );

                        document.getElementById("start").hidden = false;
                        document.getElementById("surrender").hidden = true;
                        document.getElementById("gameSelection").hidden = false;
                    }
                    else
                    {
                        game.prepend(
                            `Moves: ${moveCount}`, 
                            document.createElement("br"),
                            `Started: ${window.gameStartTime.toLocaleString()}`,
                            document.createElement("br"),
                            document.createElement("br")
                        );
                    }

                    document.querySelector("game .wrapper").style.cssText = styling;
                    
                    if (!isSolved && remainingSeconds > 0)
                    {
                        for (const cell of document.querySelectorAll("game .wrapper .cell"))
                        {
                            cell.setAttribute("onclick","toggleCell(this);");
                        }
                    }
                });
        };

        const getHighScores = () =>
        {
            const highScoreElement = document.querySelector("#highScoreModal .modal-body");

            fetch("/api/game/highscores")
                .then(response => response.json())
                .then(data => 
                {
                    let rows = ``;

                    for (const score of data)
                    {
                        rows +=
`<tr>
    <th scope="row">${score.rank}</th>
    <td>${score.username}</td>
    <td>${score.complexityLevel}</td>
    <td>${score.timeTakenSeconds} seconds</td>
    <td>${score.remainingLights}</td>
    <td>${score.noOfMoves}</td>
</tr>`
                    }

                    const html = 
`<table class="table">
    <thead>
        <tr>
        <th scope="col">#</th>
        <th scope="col">Username</th>
        <th scope="col">Complexity</th>
        <th scope="col">Time Taken</th>
        <th scope="col">Remaining Lights</th>
        <th scope="col">Move count</th>
        </tr>
    </thead>
    <tbody>
        ${rows}
    </tbody>
</table>`;
                    highScoreElement.innerHTML = html;
                });
        };
    </script>
</body>
</html>
